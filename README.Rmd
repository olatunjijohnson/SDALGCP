---
title: "README"
author: "Olatunji Johnson"
date: "18 December 2018"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  eval= FALSE)
```

# SDALGCP
SDALGCP provides a computationally efficient discrete approximation to log-Gaussian Cox process (LGCP) model for spatially aggregated disease count data. It uses Monte Carlo Maximum Likelihood for model parameter estimation and delivers prediction of spatially discrete and continuous relative risk. 

# Installation
To install the latest development of SDALGCP package use
```{r, eval=FALSE}
devtools::install_github("olatunjijohnson/SDALGCP")
```

<!-- SDALGCP provides an option to make parallel some matrix computation but the package that allows for this is not yet on cran. To install the parallel version of SDALGCP, install first the bigstatr from github -->

<!-- ```{r, eval=FALSE} -->
<!-- devtools::install_github("privefl/bigstatsr") -->
<!-- ``` -->
<!-- Then install SDALGCP from the branch using  -->

<!-- ```{r, eval=FALSE} -->
<!-- devtools::install_github("olatunjijohnson/SDALGCP#SDALGCPParallel") -->
<!-- ``` -->


# Example

Here I present an illustrative example of how to use the package

load the package
```{r}
require(SDALGCP)
```
load the data
```{r}
data("PBCshp_sf")
```
extract the dataframe containing data from the object loaded
```{r}
data <- st_drop_geometry(PBCshp_sf)
```
load the population density raster
```{r}
data("pop_den")
```
set any population density that is NA to zero
```{r}
pop_den[is.na(pop_den[])] <- 0
```
write a formula of the model you want to fit
```{r}
FORM <- X ~ propmale + Income + Employment + Education + Barriers + Crime + 
  Environment +  offset(log(pop))
```
Now to proceed to fitting the model, note that there two types of model that can be fitted. One is when approximate the intensity of LGCP by taking the population weighted average and the other is by taking the simple average. We shall consider both cases in this tutorial, starting with population weighted since we have population density on a raster grid of 300m by 300m.

## SDALGCP I (population weighted)

Here we estimate the parameters of the model

Discretise the value of scale parameter $\phi$
```{r}
phi <- seq(500, 1700, length.out = 20)
```

estimate the parameter using MCML
```{r, results = "hide",  warning = FALSE, message = FALSE}
my_est <- SDALGCPMCML(data=data, formula=FORM, my_shp=PBCshp, delta=300, phi=phi, method=1, pop_shp=terra::rast(pop_den), 
                      weighted=TRUE, par0=NULL, control.mcmc=NULL, messages = TRUE, plot_profile = TRUE)
```
To print the summary of the parameter estimates as well as the confidence interval, use;
```{r, results = "hide",  warning = FALSE, message = FALSE}
summary(my_est)
#and for confidence interval use
confint(my_est)
```
We create a function to compute the confidence interval of the scale parameter using the deviance method. It also provides the deviance plot.
```{r, results = "hide",  warning = FALSE, message = FALSE}
phiCI(my_est, coverage = 0.95, plot = TRUE)
```

Having estimated the parameters of the model, one might be interested in area-level inference or spatially continuous inference. 

1. If interested in STRICTLY area-level inference use the code below. This can either give either region-specific covariate-adjusted relative risk or region-specific incidence.  This is achieved by simply setting \code{continuous = FALSE} in the \code{SDALGCPPred} function.
```{r, results = "hide",  warning = FALSE, message = FALSE}
Dis_pred <- SDALGCPPred(para_est=my_est,  continuous=FALSE)
```

From this discrete inference one can map either the region-specific incidence or the covariate adjusted relative risk.
```{r, results = "hide",  warning = FALSE, message = FALSE}
#to map the incidence
plot(Dis_pred, type="incidence", continuous = FALSE)
#and its standard error
plot(Dis_pred, type="SEincidence", continuous = FALSE)
#to map the covariate adjusted relative risk
plot(Dis_pred, type="CovAdjRelRisk", continuous = FALSE)
#and its standard error
plot(Dis_pred, type="SECovAdjRelRisk", continuous = FALSE)
#to map the exceedance probability that the covariate-adjusted relative risk is greter than a particular threshold
plot(Dis_pred, type="CovAdjRelRisk", continuous = FALSE, thresholds=2.0)
```

2. If interested in spatially continuous prediction of the covariate adjusted relative risk. This is achieved by simply setting \code{continuous = TRUE} in the \code{SDALGCPPred} function.
```{r, results = "hide",  warning = FALSE, message = FALSE}
Con_pred <- SDALGCPPred(para_est=my_est, cellsize=2000, continuous=TRUE)
```

Then we map the spatially continuous covariate adjusted relative risk.
```{r, results = "hide",  warning = FALSE, message = FALSE}
#to map the covariate adjusted relative risk
plot(Con_pred, type="relrisk")
#and its standard error
plot(Con_pred, type="SErelrisk")
#to map the exceedance probability that the relative risk is greter than a particular threshold
plot(Con_pred, type="relrisk", thresholds=2)
```

## SDALGCP II (Unweighted)

As for the unweighted which is typically by taking the simple average of the intensity an LGCP model, the entire code in the weighted can be used by just setting \code{weighted=FALSE} in the line below.
```{r, results = "hide",  warning = FALSE, message = FALSE}
my_est2 <- SDALGCPMCML(data=data, formula=FORM, my_shp=PBCshp, delta=300, phi=phi, method=2, 
                      weighted=FALSE, par0=NULL, control.mcmc=NULL, messages = TRUE, plot_profile = TRUE)
```

# Spatio-temporal SDALGCP
Download the dataset
```{r, results = "hide",  warning = FALSE, message = FALSE}
library(sf)

# Read CSV
ohiorespMort <- read.csv("https://raw.githubusercontent.com/olatunjijohnson/dataset/master/OhioRespMort.csv")

# Download and unzip shapefile
download.file("https://github.com/olatunjijohnson/dataset/raw/master/ohio_shapefile.zip", 
              destfile = "ohio_shapefile.zip")
unzip("ohio_shapefile.zip")

# Read shapefile directly with sf
ohio_shp <- sf::st_read("ohio_shapefile/tl_2010_39_county00.shp")

# Reproject to EPSG:32617
ohio_shp <- sf::st_transform(ohio_shp, 32617)

```


create a spacetime object as an input of the spatio-temporal SDALGCP model
```{r, results = "hide",  warning = FALSE, message = FALSE}
library(dplyr)

# --- Join attributes ---
# Merge data with shapefile by county name and year
ohio_sf <- ohiorespMort %>%
  left_join(ohio_shp, by = c("NAME" = "NAME00")) %>%
  st_as_sf()  # convert to sf

# --- Add time column as Date ---
ohio_sf <- ohio_sf %>%
  mutate(time = as.Date(paste0(year + 1967, "-01-01")))

```

Plot the spatio-temporal count data
```{r, results = "hide",  warning = FALSE, message = FALSE}
spacetime::stplot(st_data[,,"Y"])
```

Parameter estimation 
```{r, results = "hide",  warning = FALSE, message = FALSE}
m <- nrow(ohio_shp)
TT <- nrow(ohio_sf)/m
formula <- y ~ year + offset(log(E))
phi <- seq(10, 300, length.out = 10)
control.mcmc <- list(n.sim=10000, burnin=2000, thin=80, h=1.65/((m*TT)^(1/6)), c1.h=0.01, c2.h=0.0001)
model.fit <- SDALGCPMCML_ST(formula=formula, st_data = ohio_sf,  delta=1200, 
                            phi=phi, method=2, pop_shp=NULL,  kappa=0.5,
                            weighted=FALSE, par0=NULL, control.mcmc=control.mcmc, 
                            plot=TRUE, plot_profile=TRUE, rho=NULL,
                            giveup=50, messages=TRUE)
summary(model.fit)
```

Area-level of the spatio-temporal prediction
```{r, results = "hide",  warning = FALSE, message = FALSE}
dis_pred <- SDALGCPPred_ST(para_est = model.fit, continuous = FALSE)
```

Ploting the area-level incidence and the covariate adjusted relative risk
```{r, results = "hide",  warning = FALSE, message = FALSE}
plot(dis_pred, type="CovAdjRelRisk", main="Relative Risk", continuous=FALSE)
plot(dis_pred,  type="incidence", main="Incidence", continuous=FALSE)
```

Spatially continuous prediction of the covariate adjusted relative risk
```{r, results = "hide",  warning = FALSE, message = FALSE}
con_pred <- SDALGCPPred_ST(para_est = model.fit, cellsize = 2500, continuous=TRUE, n.window = 1)
```

Ploting the spatially continuous covariate-adjusted relative risk
```{r, results = "hide",  warning = FALSE, message = FALSE}
plot(con_pred, type="relrisk", continuous=TRUE)
```
